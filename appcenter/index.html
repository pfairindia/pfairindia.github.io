<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air India Virtual Application Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
        <link rel="icon" href="https://ik.imagekit.io/hswtnwf8i/When_youre_on_the_go_get_important_updates_all_in_one_place__check-in_reminders_gate_announcements_live_departure_updates_and_baggage_carousel_details__You...-removebg-preview.png_ex=68a9158c&is=68a7c40c&hm=f4f6d948c6ffb05367359bb3376ab02398c91064561df3f1596f1dfc3c493093&?updatedAt=1755857790789" type="image/png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a; /* Slate-900 */
            color: #e2e8f0; /* Slate-200 */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-image: url('https://ik.imagekit.io/hswtnwf8i/Screenshot_2025-02-17_at_3.35.17_PM.png_ex=68a968be&is=68a8173e&hm=1923315b45fe33c5df76a25bd0d73e13da551dcc8dbc8ce25af9af43dad86cdb&?updatedAt=1755857710984');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .container {
            background-color: rgba(30, 41, 59, 0.9); /* Slate-800 with transparency */
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 900px;
            width: 95%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            margin: 2rem 0;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2, h3, h4 {
            font-weight: 800;
            color: #f1f5f9; /* Slate-100 */
        }
        
        .form-section {
            border-bottom: 2px solid #475569; /* Slate-600 */
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        label {
            display: block;
            text-align: left;
            margin-top: 1rem;
            font-weight: 500;
        }
        
        input[type="text"], textarea {
            width: 100%;
            background-color: #334155; /* Slate-700 */
            color: #f1f5f9;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
        }
        
        textarea {
            min-height: 120px;
        }

        .btn-primary {
            background-color: #F87171; /* Red-400 */
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(248, 113, 113, 0.4);
        }
        .btn-primary:hover {
            background-color: #EF4444; /* Red-500 */
            box-shadow: 0 6px 20px rgba(248, 113, 113, 0.6);
        }
        .btn-secondary {
            background-color: #475569; /* Slate-600 */
            color: #f1f5f9;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #64748B; /* Slate-500 */
        }

        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .message-box {
            background-color: #1e293b; /* Slate-800 */
            color: #f1f5f9;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .discord-auth-container {
            background-color: rgba(30, 41, 59, 0.9);
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 500px;
            width: 95%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .discord-auth-container a {
            padding: 1rem 2rem;
            display: inline-block;
            background-color: #5865F2; /* Discord Brand Color */
            color: white;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .discord-auth-container a:hover {
            background-color: #4752C4;
        }
    </style>
</head>
<body>

<!-- Main container for the application -->
<div id="main-app" class="w-full flex justify-center items-center flex-col p-4">

    <!-- Discord Authentication Screen -->
    <div id="discord-auth-screen" class="discord-auth-container flex flex-col items-center justify-center p-8 text-center" style="display: none;">
        <h2 class="text-3xl font-bold mb-4">Discord Authentication Required</h2>
        <p class="mb-6 text-sm text-slate-400">Please log in with Discord to verify your identity and server membership before applying. You must be in the Air India Virtual Discord server to apply.</p>
        <a id="discord-login-btn" href="#" class="btn-primary">
            Log In with Discord
        </a>
        <div id="auth-loading" class="mt-4 text-slate-400" style="display: none;">
            <p>Authenticating...</p>
        </div>
    </div>

    <!-- Application Selection Screen -->
    <div id="app-select-screen" class="container" style="display: none;">
        <h1 class="text-4xl font-extrabold mb-4">Application Center</h1>
        <p class="text-xl text-slate-400 mb-8">Choose an application type to continue.</p>
        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
            <button id="pilot-app-btn" class="w-full btn-primary text-2xl">Pilot Application</button>
            <button id="management-app-btn" class="w-full btn-primary text-2xl">Management Application</button>
        </div>
    </div>

    <!-- Pilot Application Form -->
    <div id="pilot-app-form" class="container hidden">
        <h1 class="text-4xl font-extrabold mb-2">Pilot Application</h1>
        <p class="text-xl text-slate-400 mb-8">Please fill out this form to apply as a Pilot.</p>
        <form id="pilot-form" class="space-y-6 text-left">
            <input type="hidden" id="discord-id-pilot" name="discordId">
            <input type="hidden" id="discord-username-pilot" name="discordUsername">
            
            <!-- Section 1: Basic Information -->
            <div class="form-section">
                <h3 class="text-2xl font-bold mb-4 text-slate-100">Section 1: Basic Information</h3>
                <p class="text-sm text-slate-400">This section helps us get to know you better. Please provide accurate information.</p>
                <label for="roblox-username-pilot">Enter your Roblox Username: *</label>
                <input type="text" id="roblox-username-pilot" name="robloxUsername" required class="w-full">
                
                <label for="timezone-pilot">Enter your Timezone: *</label>
                <input type="text" id="timezone-pilot" name="timezone" required class="w-full">
            </div>

            <!-- Section 2: Past Experience -->
            <div class="form-section">
                <h3 class="text-2xl font-bold mb-4 text-slate-100">Section 2: Your Past Experience</h3>
                <p class="text-sm text-slate-400">Your past experience as a virtual pilot helps us better understand your skill level and familiarity with different flight simulators. Please provide detailed and honest answers.</p>
                <label for="roblox-experience">1) How long have you been using Project Flight Simulator on Roblox? *</label>
                <input type="text" id="roblox-experience" name="robloxExperience" required class="w-full">
                
                <label for="other-simulators">2) Have you flown on other simulators such as MSFS, X-Plane, or others? If yes, please list them and describe your experience. *</label>
                <textarea id="other-simulators" name="otherSimulators" required class="w-full"></textarea>
                
                <label for="other-va">3) Do you have prior experience with any other Virtual Airlines or Flight Simulation groups? If yes, please explain in short. *</label>
                <textarea id="other-va" name="otherVa" required class="w-full"></textarea>
            </div>

            <!-- Section 3: Aviation Knowledge -->
            <div class="form-section">
                <h3 class="text-2xl font-bold mb-4 text-slate-100">Section 3: General Aviation Knowledge</h3>
                <p class="text-sm text-slate-400">This section is designed to assess your general flight knowledge, decision-making skills, and ability to handle common in-flight situations. Please answer all questions clearly and in detail.</p>
                <label for="ifr-vfr">1) Explain the difference between IFR (Instrument Flight Rules) and VFR (Visual Flight Rules). *</label>
                <textarea id="ifr-vfr" name="ifrVfr" required class="w-full"></textarea>
                
                <label for="atc-role">2) What does ATC (Air Traffic Control) do, and why is it important for safe flight operations? *</label>
                <textarea id="atc-role" name="atcRole" required class="w-full"></textarea>
                
                <label for="hold-short">3) If ATC instructs you to “hold short of runway 27,” what does that mean, and how would you respond? *</label>
                <textarea id="hold-short" name="holdShort" required class="w-full"></textarea>
                
                <label for="flight-terms">4) What do the terms “altitude,” “heading,” and “airspeed” mean, and why are they important to monitor during flight? *</label>
                <textarea id="flight-terms" name="flightTerms" required class="w-full"></textarea>
                
                <label for="safe-landing">5) What factors contribute to a safe and smooth landing, and how would you adjust if you notice you are too high or too fast on final approach? *</label>
                <textarea id="safe-landing" name="safeLanding" required class="w-full"></textarea>
            </div>

            <!-- Section 4: Commitment and Professionalism -->
            <div class="form-section">
                <h3 class="text-2xl font-bold mb-4 text-slate-100">Section 4: Commitment and Professionalism</h3>
                <p class="text-sm text-slate-400">This section helps us understand how committed you are to staying active, contributing to the community, and maintaining a professional standard.</p>
                <label for="why-join">1) Why do you want to join Air India Virtual specifically? (Minimum 3 sentences) *</label>
                <textarea id="why-join" name="whyJoin" required minlength="100" class="w-full"></textarea>

                <label for="flights-per-week">2) How many flights per week can you realistically commit to? (Be honest) *</label>
                <input type="text" id="flights-per-week" name="flightsPerWeek" required class="w-full">
                
                <label for="community-contribution">3) How would you contribute to maintaining a positive, professional environment in our virtual airline community? (Minimum 3 sentences) *</label>
                <textarea id="community-contribution" name="communityContribution" required minlength="100" class="w-full"></textarea>
            </div>

            <!-- Section 5: Acknowledgements -->
            <div class="form-section">
                <h3 class="text-2xl font-bold mb-4 text-slate-100">Section 5: Acknowledgements</h3>
                <p class="text-sm text-slate-400">Please read each acknowledgment carefully and select "Yes" to confirm your agreement.</p>
                <label for="truthful-answers">1) Do you confirm that all answers in this application are truthful and written by you personally (no AI use)? (Yes/No) *</label>
                <select id="truthful-answers" name="truthfulAnswers" required class="w-full bg-slate-700 text-slate-100 p-2 rounded-md mt-2">
                    <option value="" disabled selected>Select an option</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>

                <label for="understand-removal">2) Do you understand that inactivity or violation of rules may lead to removal from Air India Virtual? (Yes/No) *</label>
                <select id="understand-removal" name="understandRemoval" required class="w-full bg-slate-700 text-slate-100 p-2 rounded-md mt-2">
                    <option value="" disabled selected>Select an option</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>

                <label for="own-pfs">3) Do you acknowledge that you must own and fly in Project Flight Simulator on Roblox and may optionally log additional hours in MSFS, X-Plane, or other realistic simulators? (Yes/No) *</label>
                <select id="own-pfs" name="ownPfs" required class="w-full bg-slate-700 text-slate-100 p-2 rounded-md mt-2">
                    <option value="" disabled selected>Select an option</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>

            <!-- Section 6: Signature -->
            <div class="form-section">
                <h3 class="text-2xl font-bold mb-4 text-slate-100">Section 6: Signature</h3>
                <p class="text-sm text-slate-400">By signing below, you confirm all information is truthful and accurate.</p>
                <label for="roblox-signature">1) To confirm, please type your Roblox Username in ALL CAPITAL LETTERS as your digital signature. *</label>
                <input type="text" id="roblox-signature" name="robloxSignature" required pattern="[A-Z0-9_]+" class="w-full">
            </div>

            <div class="flex justify-center space-x-4 mt-6">
                <button type="submit" class="btn-primary">Submit Application</button>
            </div>
        </form>
    </div>

    <!-- Management Application Form (Placeholder) -->
    <div id="management-app-form" class="container hidden">
        <h1 class="text-4xl font-extrabold mb-2">Management Application</h1>
        <p class="text-xl text-slate-400 mb-8">This section is currently under construction. Please check back later.</p>
        <button id="back-to-selection" class="btn-secondary">Back to Selection</button>
    </div>

    <!-- Message Box Overlay -->
    <div id="message-box-overlay" class="message-box-overlay">
        <div id="message-box" class="message-box">
            <h3 id="message-title" class="text-2xl font-bold mb-2"></h3>
            <p id="message-content" class="text-slate-300"></p>
            <button id="message-box-close-btn" class="btn-primary mt-6">OK</button>
        </div>
    </div>
</div>

<!-- Firebase and Discord SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables from the Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Discord OAuth2 credentials
    const CLIENT_ID = '1408133830690209872'; // Replace with your Discord Client ID
    const REDIRECT_URI = 'https://discord.com/oauth2/authorize?client_id=1408133830690209872&response_type=code&redirect_uri=https%3A%2F%2Fpfairindia.github.io%2Fappcenter%2F&scope=identify+email+guilds';
    const REQUIRED_SERVER_ID = '1341011891941670912';

    // UI Elements
    const discordAuthScreen = document.getElementById('discord-auth-screen');
    const discordLoginBtn = document.getElementById('discord-login-btn');
    const authLoading = document.getElementById('auth-loading');
    const appSelectScreen = document.getElementById('app-select-screen');
    const pilotAppBtn = document.getElementById('pilot-app-btn');
    const managementAppBtn = document.getElementById('management-app-btn');
    const pilotAppForm = document.getElementById('pilot-app-form');
    const managementAppForm = document.getElementById('management-app-form');
    const pilotForm = document.getElementById('pilot-form');
    const backToSelectionBtn = document.getElementById('back-to-selection');

    // Message Box Elements
    const messageBoxOverlay = document.getElementById('message-box-overlay');
    const messageTitle = document.getElementById('message-title');
    const messageContent = document.getElementById('message-content');
    const messageBoxCloseBtn = document.getElementById('message-box-close-btn');

    // Global Firebase and Discord state
    let app, db, auth;
    let discordUser = null;
    let discordAuthToken = null;

    // --- UTILITY FUNCTIONS ---
    function showMessageBox(title, content) {
        messageTitle.textContent = title;
        messageContent.textContent = content;
        messageBoxOverlay.style.display = 'flex';
    }

    function hideMessageBox() {
        messageBoxOverlay.style.display = 'none';
    }

    function showScreen(screenId) {
        discordAuthScreen.style.display = 'none';
        appSelectScreen.style.display = 'none';
        pilotAppForm.style.display = 'none';
        managementAppForm.style.display = 'none';
        
        document.getElementById(screenId).style.display = 'flex';
        // Add specific flex direction for the main container
        if (screenId === 'pilot-app-form' || screenId === 'management-app-form') {
            document.getElementById('main-app').classList.add('flex-col');
        } else {
            document.getElementById('main-app').classList.remove('flex-col');
        }
    }

    async function checkServerMembership(token) {
        try {
            const response = await fetch(`https://discord.com/api/users/@me/guilds/${REQUIRED_SERVER_ID}/member`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const memberData = await response.json();
                return memberData.user; // User is in the server
            } else {
                return null; // User is not in the server or token is invalid
            }
        } catch (error) {
            console.error('Error checking server membership:', error);
            return null;
        }
    }

    // --- INITIALIZATION AND AUTHENTICATION ---
    window.addEventListener('load', async () => {
        // Initialize Firebase
        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // Log for debugging
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log('Firebase user is signed in:', user.uid);
                } else {
                    console.log('No Firebase user is signed in.');
                }
            });

            // Sign in anonymously for write access
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth error:", error);
            }
        } else {
            console.error("Firebase config is missing.");
        }

        // Handle Discord OAuth flow
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        discordAuthToken = params.get('access_token');
        
        if (discordAuthToken) {
            authLoading.style.display = 'block';
            discordLoginBtn.style.display = 'none';

            const user = await checkServerMembership(discordAuthToken);

            if (user) {
                discordUser = user;
                document.getElementById('discord-id-pilot').value = discordUser.id;
                document.getElementById('discord-username-pilot').value = `${discordUser.username}#${discordUser.discriminator}`; // Note: discriminator is now optional in Discord
                showMessageBox('Success', `Authenticated as Discord user: ${discordUser.username}. You may now choose your application.`);
                showScreen('app-select-screen');
            } else {
                showMessageBox('Authentication Failed', 'You must be a member of the required Discord server to apply.');
                showScreen('discord-auth-screen');
            }
            history.replaceState(null, null, window.location.pathname); // Clean up the URL
        } else {
            showScreen('discord-auth-screen');
        }
    });

    // --- EVENT LISTENERS ---
    discordLoginBtn.addEventListener('click', () => {
        // Replace with your actual Discord Client ID and Redirect URI
        const discordAuthUrl = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=identify%20guilds.members.read`;
        window.location.href = discordAuthUrl;
    });

    pilotAppBtn.addEventListener('click', () => {
        showScreen('pilot-app-form');
    });

    managementAppBtn.addEventListener('click', () => {
        showScreen('management-app-form');
    });

    backToSelectionBtn.addEventListener('click', () => {
        showScreen('app-select-screen');
    });

    pilotForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => data[key] = value);

        // Simple validation for minimum sentence length
        const minLength = 100; // 3 sentences
        if (data.whyJoin.length < minLength || data.communityContribution.length < minLength) {
            showMessageBox('Validation Error', 'Please ensure all questions with a minimum sentence count have been answered in enough detail.');
            return;
        }

        if (!db) {
            showMessageBox('Error', 'Database not initialized. Please refresh the page.');
            return;
        }

        const pilotAppRef = collection(db, `/artifacts/${appId}/public/data/pilot_applications`);

        try {
            await addDoc(pilotAppRef, {
                ...data,
                timestamp: new Date()
            });
            showMessageBox('Application Submitted!', 'Thank you for your application. We will review it shortly!');
            form.reset();
            showScreen('app-select-screen');
        } catch (error) {
            console.error('Error submitting application:', error);
            showMessageBox('Submission Failed', 'An error occurred while submitting your application. Please try again later.');
        }
    });

    messageBoxCloseBtn.addEventListener('click', hideMessageBox);
    messageBoxOverlay.addEventListener('click', (e) => {
        if (e.target === messageBoxOverlay) {
            hideMessageBox();
        }
    });
</script>

</body>
</html>
